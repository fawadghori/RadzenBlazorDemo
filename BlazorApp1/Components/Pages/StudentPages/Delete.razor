@page "/students/delete"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using BlazorApp1.Models
@inject IDbContextFactory<BlazorApp1.Data.BlazorApp1Context> DbFactory
@inject NavigationManager NavigationManager
@inject NotificationService NotificationService

<PageTitle>Delete Student</PageTitle>

<RadzenStack Gap="1rem">
    <RadzenText TextStyle="TextStyle.H3" TagName="TagName.H1">Delete</RadzenText>

    <RadzenAlert AlertStyle="AlertStyle.Warning" Variant="Variant.Flat" Shade="Shade.Lighter">
        <RadzenText TextStyle="TextStyle.Body1" class="rz-font-weight-bold">Are you sure you want to delete this?</RadzenText>
    </RadzenAlert>

    <RadzenText TextStyle="TextStyle.H4" TagName="TagName.H2">Student</RadzenText>

    @if (student is null)
    {
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
        <RadzenText>Loading...</RadzenText>
    }
    else
    {
        <RadzenCard>
            <RadzenStack Gap="1rem">
                <RadzenRow>
                    <RadzenColumn Size="12" SizeMD="3">
                        <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-bold">Name</RadzenText>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="9">
                        <RadzenText>@student.Name</RadzenText>
                    </RadzenColumn>
                </RadzenRow>

                <RadzenRow>
                    <RadzenColumn Size="12" SizeMD="3">
                        <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-bold">Age</RadzenText>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="9">
                        <RadzenText>@student.Age</RadzenText>
                    </RadzenColumn>
                </RadzenRow>

                <RadzenRow>
                    <RadzenColumn Size="12" SizeMD="3">
                        <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-bold">BirthDate</RadzenText>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="9">
                        <RadzenText>FormatDate(@student.BirthDate)</RadzenText>
                    </RadzenColumn>
                </RadzenRow>
            </RadzenStack>
        </RadzenCard>

        <EditForm Model="@student" OnValidSubmit="@DeleteStudent" FormName="delete">
            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" class="rz-mt-4">
                <RadzenButton ButtonType="ButtonType.Submit" Icon="delete" Text="Delete" ButtonStyle="ButtonStyle.Danger"
                              Disabled="@(student is null)" />
                <RadzenButton ButtonType="ButtonType.Button" Icon="arrow_back" Text="Back to List" ButtonStyle="ButtonStyle.Light"
                              Click="@BackToList" />
            </RadzenStack>
        </EditForm>
    }
</RadzenStack>

@code {
    private Student? student;

    [SupplyParameterFromQuery]
    private int Id { get; set; }

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        student = await context.Student.FirstOrDefaultAsync(m => m.Id == Id);

        if (student is null)
        {
            NavigationManager.NavigateTo("notfound");
        }
    }

    private async Task DeleteStudent()
    {
        using var context = DbFactory.CreateDbContext();
        context.Student.Remove(student!);
        await context.SaveChangesAsync();

        NotificationService.Notify(new NotificationMessage
        {
            Severity = NotificationSeverity.Success,
            Summary = "Success",
            Detail = "Student deleted successfully",
            Duration = 4000
        });

        NavigationManager.NavigateTo("/students");
    }

    private void BackToList()
    {
        NavigationManager.NavigateTo("/students");
    }

    private string FormatDate(DateOnly date)
    {
        return $"{date.Day:D2}/{date.Month:D2}/{date.Year}";
    }
}