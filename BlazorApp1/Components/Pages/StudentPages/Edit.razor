@page "/students/edit"
@using Microsoft.EntityFrameworkCore
@using BlazorApp1.Models
@inject IDbContextFactory<BlazorApp1.Data.BlazorApp1Context> DbFactory
@inject NavigationManager NavigationManager
@inject NotificationService NotificationService

<PageTitle>Edit Student</PageTitle>

<RadzenStack Gap="1rem">
    <RadzenText TextStyle="TextStyle.H3" TagName="TagName.H1">Edit</RadzenText>
    <RadzenText TextStyle="TextStyle.H4" TagName="TagName.H2">Student</RadzenText>

    @if (Student is null)
    {
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
        <RadzenText>Loading...</RadzenText>
    }
    else
    {
        <RadzenCard>
            <EditForm Model="@Student" OnValidSubmit="@UpdateStudent" FormName="edit">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <RadzenStack Gap="1rem">
                    <RadzenRow>
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenFormField Text="Name" Variant="Variant.Outlined">
                                <ChildContent>
                                    <RadzenTextBox @bind-Value="Student.Name" Name="Name" Style="width: 100%;" />
                                </ChildContent>
                                <Helper>
                                    <RadzenRequiredValidator Component="Name" Text="Name is required" />
                                </Helper>
                            </RadzenFormField>
                        </RadzenColumn>
                    </RadzenRow>

                    <RadzenRow>
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenFormField Text="Age" Variant="Variant.Outlined">
                                <ChildContent>
                                    <RadzenNumeric @bind-Value="Student.Age" Name="Age" Style="width: 100%;" />
                                </ChildContent>
                                <Helper>
                                    <RadzenRequiredValidator Component="Age" Text="Age is required" />
                                </Helper>
                            </RadzenFormField>
                        </RadzenColumn>
                    </RadzenRow>

                    <RadzenRow>
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenFormField Text="BirthDate" Variant="Variant.Outlined">
                                <ChildContent>
                                    <RadzenDatePicker @bind-Value="Student.BirthDate" Name="BirthDate" DateFormat="dd/MM/yyyy" Style="width: 100%;" />
                                </ChildContent>
                                <Helper>
                                    <RadzenRequiredValidator Component="BirthDate" Text="BirthDate is required" />
                                </Helper>
                            </RadzenFormField>
                        </RadzenColumn>
                    </RadzenRow>

                    <RadzenRow>
                        <RadzenColumn>
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" class="rz-mt-4">
                                <RadzenButton ButtonType="ButtonType.Submit" Icon="save" Text="Save" ButtonStyle="ButtonStyle.Primary" />
                                <RadzenButton ButtonType="ButtonType.Button" Icon="cancel" Text="Back to List" ButtonStyle="ButtonStyle.Light"
                                              Click="@BackToList" />
                            </RadzenStack>
                        </RadzenColumn>
                    </RadzenRow>
                </RadzenStack>
            </EditForm>
        </RadzenCard>
    }
</RadzenStack>

@code {
    [SupplyParameterFromQuery]
    private int Id { get; set; }

    [SupplyParameterFromForm]
    private Student? Student { get; set; }

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        Student ??= await context.Student.FirstOrDefaultAsync(m => m.Id == Id);

        if (Student is null)
        {
            NavigationManager.NavigateTo("notfound");
        }
    }

    private async Task UpdateStudent()
    {
        using var context = DbFactory.CreateDbContext();
        context.Attach(Student!).State = EntityState.Modified;

        try
        {
            await context.SaveChangesAsync();

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Success",
                Detail = "Student updated successfully",
                Duration = 4000
            });

            NavigationManager.NavigateTo("/students");
        }
        catch (DbUpdateConcurrencyException)
        {
            if (!StudentExists(Student!.Id))
            {
                NavigationManager.NavigateTo("notfound");
            }
            else
            {
                throw;
            }
        }
    }

    private bool StudentExists(int id)
    {
        using var context = DbFactory.CreateDbContext();
        return context.Student.Any(e => e.Id == id);
    }

    private void BackToList()
    {
        NavigationManager.NavigateTo("/students");
    }
}